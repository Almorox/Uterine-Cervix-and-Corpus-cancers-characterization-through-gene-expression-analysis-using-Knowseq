---
title: "Creación de la matriz corregida"
author: "Lucía Almorox Antón"
date: "2023-01-24"
output: html_document
---

This code was created for the study "Uterine Cervix and Corpus Cancers Characterization through Gene Expression Analysis Using the Knowseq Tool".

Department of Computer Engineering, Automatics and Robotics,University of Granada. C.I.T.I.C., Periodista Rafael G´omez Montero, 2, 18014. Granada, Spain.

luciaalmorox@correo.ugr.es

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
require(KnowSeq)
require(caret)
par(mar=c(3,3,2,2))
set.seed(111)
memory.limit(size=10000)
```

Creación d elos archivos count:

```{r}
samples <- read.table(file = 'utero_sample_sheet.tsv', sep = '\t', header = TRUE, eval = FALSE)
convert_tsv_to_counts <- function(file) {
  # Leemos el archivo tsv en un data frame
  df <- read.table(file = file, sep = '\t', header = TRUE)
  # Seleccionamos las columnas 1 y 4 del data frame
  df <- df[, c(1, 4)]
  # Tomamos solo las filas desde la 5 hasta la última
  df <- df[5:nrow(df), ]
  # Guardamos el data frame en formato csv, aunque le ponemos extensión counts. Da igual, sería cuestión de adaptar el código de después.
  write.table(df, file = paste0(file, ".counts"), sep = "\t", row.names = FALSE,
              col.names =FALSE,quote = FALSE)
}
# Recorremos cada directorio, según están en la hoja de samples.
n <- nrow(samples)
for (i in 1:n) {
  # Cambiamos al directorio
  print(samples$File.ID[i])
  setwd(samples$File.ID[i])
  # Aplicamos la función convert_tsv_to_csv a cada archivo tsv
  convert_tsv_to_counts(samples$File.Name[i])
  # Volvemos al directorio anterior
  setwd("..")
}

```


A continuación, determinamos la clase a la que pertenece cada una de las muestras (HEALTHY, CERVIX o CORPUS).

- Las muestras con el valor 'Solid Tissue Normal' corresponden a muestras sanas. 

```{r}
samples <- read.table(file = 'utero_sample_sheet.tsv', sep = '\t', header = TRUE)
Class <- samples$Sample.Type
Class[Class=='Solid Tissue Normal'] <- 'HEALTHY'

```


- Las muestras del proyecto TCGA-CESC corresponden a muestras de cáncer de cérvix (en el caso de que no se traten de muestras sanas).

```{r}
Class[Class != 'HEALTHY' & samples$Project.ID=='TCGA-CESC'] <- 'CERVIX_TUMOR'

```

- Las muestras del proyecto TCGA-SARC corresponden a muestras de cáncer de cérvix (en el caso de que no se traten de muestras sanas)

Observamos el número de muestras de cada tipo.
```{r}
Class[Class != 'HEALTHY' & (samples$Project.ID=='TCGA-SARC' | samples$Project.ID=='TCGA-UCEC')] <- 'CORPUS_TUMOR'
table(Class)
```

Creamos y guardamos el archivo necesario para trabajar con él en KnowSeq.

```{r}
# Creamos las variables necesarias
Run <- paste(samples$File.Name,".counts",sep = "")
Path <- paste("./",samples$File.ID,sep = "")
# Exportamos DataFrame a CSV
data.info <- data.frame(Run = Run, Path = Path, Class = Class)
write.csv(file = "data_info.csv", x = data.info)
```

Con tantas muestras no funciona (se alcanza el límite de memoria de R al crear la matriz que recoge todos los archivos count). Por ello, seleccionamos al azar 300 muestras de cada tipo de muestra cancerosa (mantenemos todas las muestras sanas). Guardamos otra vez el archivo con la información relativa a estas muestras seleccionadas.

```{r}
cervix <- data.info[data.info$Class=='CERVIX_TUMOR',]
corpus <- data.info[data.info$Class=='CORPUS_TUMOR',]
healthy <- data.info[data.info$Class=='HEALTHY',]
index_cervix <- sample(seq(1:nrow(cervix)),300)
index_corpus <- sample(seq(1:nrow(corpus)),300)
cervix_300 <- cervix[index_cervix,]
corpus_300 <- corpus[index_corpus,]
min_data_info <- rbind(cervix_300,corpus_300,healthy)
nrow(min_data_info)
head(min_data_info)
write.csv(file = "min_data_info300.csv", x = min_data_info)
```

Llevamos a cabo el preprocesamiento necesario para obtener la matriz corregida de expresión de cada gen en cada muestra. Guardamos dicha matriz y las etiquetas correspondientes a las muestras que han pasado los filtros de calidad. Estos objetos se utilizarán en el fichero "Clasificación_CERVIX_CORPUS_HEALTHY.Rmd"

```{r}

# Cargamos y aunamos los ficheros count (tenemos los genes en filas y las 
# muestras en columnas).
countsInfo <- countsToMatrix("min_data_info300.csv", extension = "")

# Exportamos tanto la matriz de datos como los labels a nuevas variables
countsMatrix <- countsInfo$countsMatrix
labels <- countsInfo$labels

# Consultamos los Gene Symbols y el GC content de cada gen
# (si el valor de GC es muy grande es indicativo de que la secuenciación no
# ha ido bien, pero no vamos a prestarle atención en este caso).
myAnnotation <- getGenesAnnotation(rownames(countsMatrix))

# Calculamos los valores de expresión usando la matriz de count y la anotación 
# previamente adquirida
geneExprMatrix <- calculateGeneExpressionValues(countsMatrix, annotation = myAnnotation)
# Se está haciendo ya una primera normalización aunque no es la normalización completa. 
# (los valores de conteo no son "raw" ya).
save(geneExprMatrix,file="geneEMAT.RData")


# Nos quedamos solo con los genes que tienen nombre, o sea, aquellos que se 
# conocen.
geneExprMatrix <- geneExprMatrix[!is.na(rownames(geneExprMatrix)),]
# Realizamos el analisis de calidad de RNAseq: eliminamos aquellas muestras 
# que puede que tengan peor calidad o cuya distribucion de expresión se
# aleje mucho de la distribución del resto de muestras (outliers).
# Si ha eliminado alguna muestra el número de columnas se verá reducido.
QAResults <- RNAseqQA(geneExprMatrix, toRemoval = TRUE, toPNG=FALSE, toPDF=FALSE)

qualityMatrix <- QAResults$matrix

# Actualizamos el objeto Labels para quedarnos solo con las que corresponden
# a las muestras que han quedado tras la eliminación de outliers.
qualityLabels <- labels[-which(colnames(geneExprMatrix) %in% QAResults$outliers)]

table(qualityLabels) #Vemos el número de meustras que ha quitado de cada clase.

# Creamos el modelo SVA de variables subrogadas para tratar el efecto batch
  # Observamos la gráfica antes de eliminar el efecto batch
dataPlot(qualityMatrix, qualityLabels, mode = "orderedBoxplot")
batchMatrix <- batchEffectRemoval(qualityMatrix, qualityLabels, method = "sva")
 # Observamos la gráfica después de eliminar el efecto batch
dataPlot(batchMatrix, qualityLabels, mode = "orderedBoxplot")
save(batchMatrix,file="MATRIZ_LIMPIA.RData")
save(qualityLabels,file="quality_labels.RData")
save(index_cervix,file="index_cervix.RData")
save(index_corpus,file="index_corpus.RData")
```