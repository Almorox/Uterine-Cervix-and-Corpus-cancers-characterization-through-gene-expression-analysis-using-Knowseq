---
title: "Creación de la matriz limpia (clases: ADENO, SQUAMOUS)"
author: "Lucía Almorox Antón"
date: "2023-01-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(KnowSeq)
rm(list = ls())
memory.limit(size=10000)
set.seed(111)
```

Creación de archivos count:

```{r}
samples <- read.table(file = 'SAMPLES_CERVIX.tsv', sep = '\t', header = TRUE)
convert_tsv_to_counts <- function(file) {
  # Leemos el archivo tsv en un data frame
  df <- read.table(file = file, sep = '\t', header = TRUE)
  # Seleccionamos las columnas 1 y 4 del data frame
  df <- df[, c(1, 4)]
  # Tomamos solo las filas desde la 5 hasta la última
  df <- df[5:nrow(df), ]
  # Guardamos el data frame en formato csv, aunque le ponemos extensión counts. Da igual, sería cuestión de adaptar el código de después.
  write.table(df, file = paste0(file, ".counts"), sep = "\t", row.names = FALSE,
              col.names =FALSE,quote = FALSE)
}
# Recorremos cada directorio, según están en la hoja de samples.
n <- nrow(samples)
for (i in 1:n) {
  # Cambiamos al directorio
  print(samples$File.ID[i])
  setwd(samples$File.ID[i])
  # Aplicamos la función convert_tsv_to_csv a cada archivo tsv
  convert_tsv_to_counts(samples$File.Name[i])
  # Volvemos al directorio anterior
  setwd("..")
}

```

Creación de las clases de interés.

- Las muestras con el valor 'Solid Tissue Normal' corresponden a muestras sanas. 

```{r}
samples <- read.table(file = 'SAMPLES_CERVIX.tsv', sep = '\t', header = TRUE)
Class <- samples$Sample.Type
Class[Class=='Solid Tissue Normal'] <- 'HEALTHY'
table(Class)
```

```{r}
library(readr)
clinical <- read_delim(file = 'clinical.tsv')
```

Observamos las categorías presentes en el fichero clinical, en el campo primary_diagnosis.

```{r}
table(clinical$primary_diagnosis)

```

Para las muestras que no son sanas, hacemos que su clase sea la que aparece en el campo primary_diagnosis del fichero clinical para esa persona, es decir, utilizando el campo case_id como campo común entre el fichero samplesheet y clinical.

```{r}
for (i in 1:nrow(samples)){
  if (Class[i] != 'HEALTHY'){
    CASE_ID_i <- samples$Case.ID[i]
    clinical_i <- clinical[clinical$case_submitter_id==CASE_ID_i,]
    ENF <- clinical_i$primary_diagnosis[1]
    Class[i] <- ENF
  }
}
```


Observamos las clases que tenemos ahora.
```{r}
table(Class)
```

Agrupamos las muestras en dos clases: ADENO y SQUAMOUS.
Las muestras de la clase 'Adenosquamous carcinoma' y 'HEALTHY' serán eliminadas posteriormente.

```{r}
Class[Class=='Adenocarcinoma, endocervical type'|Class=='Adenocarcinoma, NOS'|Class=='Endometrioid adenocarcinoma, NOS'] <- 'ADENO'
Class[Class=='Adenosquamous carcinoma'] <- 'DELETE'
Class[Class != 'DELETE' & Class != 'ADENO' & Class !='HEALTHY'] <- 'SQUAMOUS'

table(Class)
```

Creamos el objeto con la información relativa a todas las muestras.
```{r}
# Creamos las variables necesarias
Run <- paste(samples$File.Name,".counts",sep = "")
Path <- paste("./",samples$File.ID,sep = "")
# Exportamos DataFrame a CSV
data.info <- data.frame(Run = Run, Path = Path, Class = Class)
#write.csv(file = "data_info_STAGES.csv", x = data.info)
```

Eliminamos de él las muestras cuya clase no nos interesa y guardamos el objeto como archivo csv.

```{r}
data.info <- data.info[!(data.info$Class=='HEALTHY'|data.info$Class=='DELETE'),]

table(data.info$Class)
write.csv(file = "data_info.csv", x = data.info)
```


Llevamos a cabo el preprocesamiento necesario para obtener la matriz corregida de expresión de cada gen en cada muestra. Guardamos dicha matriz y las etiquetas correspondientes a las muestras que han pasado los filtros de calidad. Estos objetos se utilizarán en el fichero "Clasificación_cervix_ADENO_SQUAMOUS.Rmd"

```{r}

# Cargamos y aunamos los ficheros count (tenemos los genes en filas y las 
# muestras en columnas).
countsInfo <- countsToMatrix("data_info.csv", extension = "")

# Exportamos tanto la matriz de datos como los labels a nuevas variables
countsMatrix <- countsInfo$countsMatrix
labels <- countsInfo$labels

# Consultamos los Gene Symbols y el GC content de cada gen
# (si el valor de GC es muy grande es indicativo de que la secuenciación no
# ha ido bien, pero no vamos a prestarle atención en este caso).
myAnnotation <- getGenesAnnotation(rownames(countsMatrix))

# Calculamos los valores de expresión usando la matriz de count y la anotación 
# previamente adquirida
geneExprMatrix <- calculateGeneExpressionValues(countsMatrix, annotation = myAnnotation)
# Se está haciendo ya una primera normalización aunque no es la normalización completa. 
# (los valores de conteo no son "raw" ya).
save(geneExprMatrix,file="geneEMAT.RData")


# Nos quedamos solo con los genes que tienen nombre, o sea, aquellos que se 
# conocen.
geneExprMatrix <- geneExprMatrix[!is.na(rownames(geneExprMatrix)),]
# Realizamos el analisis de calidad de RNAseq: eliminamos aquellas muestras 
# que puede que tengan peor calidad o cuya distribucion de expresión se
# aleje mucho de la distribución del resto de muestras (outliers).
# Si ha eliminado alguna muestra el número de columnas se verá reducido.
QAResults <- RNAseqQA(geneExprMatrix, toRemoval = TRUE, toPNG=FALSE, toPDF=FALSE)

qualityMatrix <- QAResults$matrix

# Actualizamos el objeto Labels para quedarnos solo con las que corresponden
# a las muestras que han quedado tras la eliminación de outliers.
qualityLabels <- labels[-which(colnames(geneExprMatrix) %in% QAResults$outliers)]

table(qualityLabels) #Vemos el número de meustras que ha quitado de cada clase.

# Creamos el modelo SVA de variables subrogadas para tratar el efecto batch
  # Observamos la gráfica antes de eliminar el efecto batch
dataPlot(qualityMatrix, qualityLabels, mode = "orderedBoxplot")
batchMatrix <- batchEffectRemoval(qualityMatrix, qualityLabels, method = "sva")
 # Observamos la gráfica después de eliminar el efecto batch
#dataPlot(batchMatrix, qualityLabels, mode = "orderedBoxplot")
save(batchMatrix,file="MATRIZ_LIMPIA.RData")
save(qualityLabels,file="quality_labels.RData")

```
